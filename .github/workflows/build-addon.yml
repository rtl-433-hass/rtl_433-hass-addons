name: Build Addon (Reusable)

on:
  workflow_call:
    inputs:
      build-type:
        description: |
          Build type determines what gets built and how:
          - test: all addons, no push (for CI verification)
          - release: stable addons only, push with version from config.json
          - nightly: -next addons only, push with version "next"
        required: true
        type: string
      checkout-ref:
        description: 'Git ref to checkout (default: current ref)'
        required: false
        type: string
        default: ''
      skip-tag-check:
        description: 'Skip checking if tag already exists'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: Build ${{ matrix.addon }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    strategy:
      matrix:
        arch: [amd64, aarch64]
        addon: [rtl_433, rtl_433-next, rtl_433_mqtt_autodiscovery, rtl_433_mqtt_autodiscovery-next]
        include:
          - arch: amd64
            runner: ubuntu-24.04
            builder_image: amd64
          - arch: aarch64
            runner: ubuntu-24.04-arm
            builder_image: aarch64
        exclude:
          # release builds only stable addons
          - addon: ${{ inputs.build-type == 'release' && 'rtl_433-next' || '' }}
          - addon: ${{ inputs.build-type == 'release' && 'rtl_433_mqtt_autodiscovery-next' || '' }}
          # nightly builds only -next addons
          - addon: ${{ inputs.build-type == 'nightly' && 'rtl_433' || '' }}
          - addon: ${{ inputs.build-type == 'nightly' && 'rtl_433_mqtt_autodiscovery' || '' }}

    steps:
    - name: Checkout the repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        ref: ${{ inputs.checkout-ref || github.ref }}

    - name: Make sure tag doesn't exist
      if: inputs.build-type == 'release' && !inputs.skip-tag-check
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y jq
        set -x
        TAG=$(jq '.version' < rtl_433/config.json)
        ! docker manifest inspect "ghcr.io/${{ github.repository}}-${{ matrix.addon }}-${{ matrix.arch }}:$TAG" > /dev/null

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@6f7a8d2348e2a4aa5defafcdaafe5aef3f83bd4b # v5

    - name: Login to Packages Container registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Determine image version
      id: version
      run: |
        if [ "${{ inputs.build-type }}" == "release" ]; then
          # For release builds, get version from config.json
          # Use the base addon directory (without -next suffix)
          BASE_ADDON="${{ matrix.addon }}"
          BASE_ADDON="${BASE_ADDON%-next}"
          VERSION=$(jq -r '.version' < "${BASE_ADDON}/config.json")
        elif [ "${{ inputs.build-type }}" == "nightly" ]; then
          VERSION="next"
        else
          VERSION="${{ env.GITHUB_REF_SLUG }}"
        fi
        IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.addon }}-${{ matrix.arch }}"
        {
          echo "version=${VERSION}"
          echo "image_name=${IMAGE_NAME}"
          echo "full_image=${IMAGE_NAME}:${VERSION}"
        } >> "$GITHUB_OUTPUT"

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
      with:
        images: ${{ steps.version.outputs.image_name }}
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}

    - name: Copy files for next addon variants
      run: |
        if [ "${{ matrix.addon }}" == "rtl_433-next" ]; then
          cp -nv -R rtl_433/* ${{ matrix.addon }}/
        fi
        if [ "${{ matrix.addon }}" == "rtl_433_mqtt_autodiscovery-next" ]; then
          cp -nv -R rtl_433_mqtt_autodiscovery/* ${{ matrix.addon }}/
        fi

    - name: Build addon image
      id: build
      uses: home-assistant/builder@master
      with:
        image: ${{ matrix.builder_image }}
        args: |
          --${{ matrix.arch }} \
          --docker-hub $REGISTRY \
          --image ${{ github.repository}}-${{ matrix.addon }}-{arch} \
          --no-latest \
          --target ${{ matrix.addon }} \
          ${{ inputs.build-type == 'test' && '--test --self-cache --version' || '' }} \
          ${{ inputs.build-type == 'test' && env.GITHUB_REF_SLUG || '' }} \
          ${{ inputs.build-type == 'nightly' && '--version next' || '' }}

    - name: Get image digest
      id: digest
      if: inputs.build-type != 'test'
      run: |
        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${{ steps.version.outputs.full_image }}" | cut -d'@' -f2)
        echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
        echo "Image digest: ${DIGEST}"

    # This step generates an artifact attestation for the image, which is an unforgeable
    # statement about where and how it was built. It increases supply chain security for
    # people who consume the image.
    - name: Generate artifact attestation
      if: inputs.build-type != 'test'
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
      with:
        subject-name: ${{ steps.version.outputs.image_name }}
        subject-digest: ${{ steps.digest.outputs.digest }}
        push-to-registry: true
