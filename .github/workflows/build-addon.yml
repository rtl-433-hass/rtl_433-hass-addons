name: Build Addon (Reusable)

on:
  workflow_call:
    inputs:
      build-type:
        description: |
          Build type determines what gets built and how:
          - test: all addons, no push (for CI verification)
          - release: stable addons only, push with version from config.json
          - nightly: -next addons only, push with version "next"
        required: true
        type: string
      checkout-ref:
        description: 'Git ref to checkout (default: current ref)'
        required: false
        type: string
        default: ''
      skip-tag-check:
        description: 'Skip checking if tag already exists'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: Build ${{ matrix.addon }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        arch: [amd64, aarch64]
        addon: [rtl_433, rtl_433-next, rtl_433_mqtt_autodiscovery, rtl_433_mqtt_autodiscovery-next]
        include:
          - arch: amd64
            runner: ubuntu-24.04
            builder_image: amd64
          - arch: aarch64
            runner: ubuntu-24.04-arm
            builder_image: aarch64
        exclude:
          # release builds only stable addons
          - addon: ${{ inputs.build-type == 'release' && 'rtl_433-next' || '' }}
          - addon: ${{ inputs.build-type == 'release' && 'rtl_433_mqtt_autodiscovery-next' || '' }}
          # nightly builds only -next addons
          - addon: ${{ inputs.build-type == 'nightly' && 'rtl_433' || '' }}
          - addon: ${{ inputs.build-type == 'nightly' && 'rtl_433_mqtt_autodiscovery' || '' }}

    steps:
    - name: Checkout the repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        ref: ${{ inputs.checkout-ref || github.ref }}

    - name: Make sure tag doesn't exist
      if: inputs.build-type == 'release' && !inputs.skip-tag-check
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y jq
        set -x
        TAG=$(jq '.version' < rtl_433/config.json)
        ! docker manifest inspect "ghcr.io/${{ github.repository}}-${{ matrix.addon }}-${{ matrix.arch }}:$TAG" > /dev/null

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@6f7a8d2348e2a4aa5defafcdaafe5aef3f83bd4b # v5

    - name: Login to Packages Container registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Copy files for next addon variants
      run: |
        if [ "${{ matrix.addon }}" == "rtl_433-next" ]; then
          cp -nv -R rtl_433/* ${{ matrix.addon }}/
        fi
        if [ "${{ matrix.addon }}" == "rtl_433_mqtt_autodiscovery-next" ]; then
          cp -nv -R rtl_433_mqtt_autodiscovery/* ${{ matrix.addon }}/
        fi

    - name: Build addon image
      uses: home-assistant/builder@master
      with:
        image: ${{ matrix.builder_image }}
        args: |
          --${{ matrix.arch }} \
          --docker-hub $REGISTRY \
          --image ${{ github.repository}}-${{ matrix.addon }}-{arch} \
          --no-latest \
          --target ${{ matrix.addon }} \
          ${{ inputs.build-type == 'test' && '--test --self-cache --version' || '' }} \
          ${{ inputs.build-type == 'test' && env.GITHUB_REF_SLUG || '' }} \
          ${{ inputs.build-type == 'nightly' && '--version next' || '' }}
