---
name: Smoke Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  smoke-test-rtl433:
    name: Smoke test rtl_433 addon
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Build rtl_433 addon image
        run: |
          docker build \
            --build-arg BUILD_FROM=alpine:3.21 \
            --tag rtl_433-test:latest \
            ./rtl_433

      - name: Verify rtl_433 binary exists
        run: |
          docker run --rm rtl_433-test:latest which rtl_433

      - name: Verify rtl_433 --help works
        run: |
          docker run --rm rtl_433-test:latest rtl_433 --help

      - name: Verify rtl_433 lists protocols
        run: |
          docker run --rm rtl_433-test:latest rtl_433 -R help 2>&1 | head -20

      - name: Verify run.sh is executable
        run: |
          docker run --rm rtl_433-test:latest test -x /run.sh

  smoke-test-autodiscovery:
    name: Smoke test autodiscovery addon
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Build autodiscovery addon image
        run: |
          docker build \
            --build-arg BUILD_FROM=python:3.12-alpine3.21 \
            --tag autodiscovery-test:latest \
            ./rtl_433_mqtt_autodiscovery

      - name: Verify Python is available
        run: |
          docker run --rm autodiscovery-test:latest python3 --version

      - name: Verify rtl_433_mqtt_hass.py exists and is valid Python
        run: |
          docker run --rm autodiscovery-test:latest python3 -m py_compile /rtl_433_mqtt_hass.py

      - name: Verify paho-mqtt is installed
        run: |
          docker run --rm autodiscovery-test:latest python3 -c "import paho.mqtt.client; print('paho-mqtt OK')"

      - name: Verify run.sh is executable
        run: |
          docker run --rm autodiscovery-test:latest test -x /run.sh

      - name: Verify rtl_433_mqtt_hass.py --help works
        run: |
          docker run --rm autodiscovery-test:latest python3 /rtl_433_mqtt_hass.py --help || true
